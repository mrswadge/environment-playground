# -*- mode: ruby -*-
# vi: set ft=ruby :

# Java 21 Development Environment Vagrantfile
# Installs OpenJDK 21 (LTS), Maven, and Gradle

Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/jammy64"
  config.vm.hostname = "java21-dev"

  # Network configuration
  config.vm.network "private_network", ip: "192.168.56.20"

  # Port forwarding for typical Java applications
  config.vm.network "forwarded_port", guest: 8080, host: 8090
  config.vm.network "forwarded_port", guest: 8443, host: 8447

  # VM resources
  config.vm.provider "virtualbox" do |vb|
    vb.name = "java21-dev-vm"
    vb.memory = "2048"
    vb.cpus = 2
  end

  # Shared folder for projects
  config.vm.synced_folder "./projects", "/home/vagrant/projects", create: true

  # Provisioning script
  config.vm.provision "shell", inline: <<-SHELL
    apt-get update
    apt-get install -y wget curl git unzip

    # Install OpenJDK 21
    apt-get install -y openjdk-21-jdk

    # Install Maven 3.9.x
    MAVEN_VERSION="3.9.6"
    cd /tmp
    wget -q https://archive.apache.org/dist/maven/maven-3/${MAVEN_VERSION}/binaries/apache-maven-${MAVEN_VERSION}-bin.tar.gz
    tar xzf apache-maven-${MAVEN_VERSION}-bin.tar.gz
    mv apache-maven-${MAVEN_VERSION} /opt/maven
    
    # Install Gradle 8.x
    GRADLE_VERSION="8.5"
    wget -q https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip
    unzip -q gradle-${GRADLE_VERSION}-bin.zip
    mv gradle-${GRADLE_VERSION} /opt/gradle

    # Set environment variables
    cat > /etc/profile.d/java21.sh << 'EOF'
export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
export MAVEN_HOME=/opt/maven
export GRADLE_HOME=/opt/gradle
export PATH=$JAVA_HOME/bin:$MAVEN_HOME/bin:$GRADLE_HOME/bin:$PATH
EOF

    source /etc/profile.d/java21.sh

    # Verify installation
    echo "=== Java Version ==="
    java -version
    echo "=== Maven Version ==="
    /opt/maven/bin/mvn -version
    echo "=== Gradle Version ==="
    /opt/gradle/bin/gradle -version
  SHELL
end
